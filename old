pipeline {
	agent any
    environment {
        vcenter_cred = credentials('02ce81e7-6ab7-4c43-bc82-6104fe08b769')
    }
    parameters {
        string(name: 'vmname', description '')
        string(name: 'vcenter', description '')
        string(name: 'datacenter', description '')
        string(name: 'cluster', description '')
        string(name: 'datastore', description '')
        string(name: 'portgroup', description '')
        string(name: 'ip', description '')
        string(name: 'gateway', description '')
        string(name: 'netmask', description '')
        string(name: 'dns_p', description '')
        string(name: 'dns_s', description '')
        string(name: 'dns_t', description '')
        
    }    
	stages {
		stage('prerequisites checks') {
			steps {
                powershell '''
                    Get-Module -ListAvailable VMware* | Import-Module | Out-Null
                    Connect-VIServer -Server $env:vcenter_server -User $env:vcenter_cred_USR -Password $env:vcenter_cred_PSW -erroraction stop
                    $vm = Get-VM $env:vm_1
                    Write-Output $vm.name
                    Disconnect-VIServer -Force -Server $env:vcenter_server -Confirm:$false
                    $env:vmid = $vm.name
                '''
			}
		}
		stage('stage #2') {
			steps {
				powershell '.\\Get-VM.ps1 -usr $env:vcenter_cred_USR -psw $env:vcenter_cred_PSW -vmname $env:vm_2 -vcenter $env:vcenter_server'
			}
		}
        stage('stage #3') {
            parallel {
                stage('stage #3.1') {
                    steps {
                        powershell 'write-output "my value is $($env:vmid)"'
                    }
                }
                stage('stage #3.2') {
                    steps {
                        powershell 'sleep 2'
                    }
                }
            }
        }
	}
    post {
        failure {
            powershell 'write-output "this runs on fail"'
        }
        always {
            powershell 'write-output "this runs always"'
        }
    }
}




https://issues.jenkins-ci.org/browse/JENKINS-13119



        if ("ad.piccola.us".equals(win_domain)) {
            def vcenter_user = vcenter_cred_adpiccolaus_USR
            return vcenter_user
        }